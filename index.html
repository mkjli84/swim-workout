<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€í™”í˜• ìˆ˜ì˜ ì¸í„°ë²Œ í›ˆë ¨ + TTS ì½”ì¹˜</title>
    <!-- 
        [ìµœì¢… CSP ìˆ˜ì •]
        ê°€ì¥ í”í•œ CSP ì‹¤íŒ¨ ì§€ì ì¸ 'connect-src'ë¥¼ ìµœëŒ€í•œ ê°œë°©ì ìœ¼ë¡œ ì„¤ì •í•˜ê³ ,
        'script-src'ì— 'unsafe-eval'ì„ ì¶”ê°€í•˜ì—¬ í˜¸ìŠ¤íŒ… í™˜ê²½ì˜ ì œì•½ì„ ì™„í™”í•©ë‹ˆë‹¤.
    -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
        connect-src 'self' https://generativelanguage.googleapis.com https://www.googleapis.com;
        font-src 'self' data:; 
        img-src 'self' data:;  
        media-src 'self' data: blob:;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Aqua & Ash (bg-slate-50, bg-white, text-slate-700, accent-blue-600) -->
    <style>
        body {
            font-family: 'Inter', 'Pretendard', sans-serif;
        }
        .tab-active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        .task-list-item input:checked + label {
            text-decoration: line-through;
            color: #6b7280;
        }
        /* Mobile optimization for visibility */
        @media (min-width: 640px) {
            .task-list-item input:checked + label .task-distance {
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-full flex items-start justify-center py-4 px-2 min-h-screen">
    <main class="w-full max-w-xl bg-white shadow-xl rounded-2xl overflow-hidden my-4">
        
        <!-- Header -->
        <header class="p-4 md:p-6 border-b border-slate-200">
            <h1 class="text-xl md:text-2xl font-bold text-blue-700">ğŸŠ ì§€êµ¬ë ¥ í–¥ìƒ ì¸í„°ë²Œ í›ˆë ¨ (25Y)</h1>
            <p class="text-sm md:text-base text-slate-600 mt-1">ì‹¬í ì§€êµ¬ë ¥ ê°•í™” ë° ì –ì‚° ì—­ì¹˜ ìœ ì§€ë¥¼ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ ê°€ì´ë“œ</p>
            
            <div class="flex flex-wrap gap-3 mt-3 text-xs md:text-sm">
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-medium">ğŸ¯ ì´ ê±°ë¦¬: 2,700 Y</span>
                <span class="bg-slate-100 text-slate-800 px-3 py-1 rounded-full font-medium">â±ï¸ ì˜ˆìƒ ì‹œê°„: 60-75ë¶„</span>
            </div>
        </header>

        <!-- Progress Bar (Reduced bottom padding) -->
        <section class="px-4 pt-4 pb-2 md:px-6 md:pt-6 md:pb-3">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-slate-700">í›ˆë ¨ ì§„í–‰ë¥ </span>
                <span id="progress-text" class="text-sm font-bold text-blue-600">0 / 2700 Y</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </section>

        <!-- Main Content Area (Refactored for persistent tabs) -->
        <div class="px-4 pt-2 pb-8 md:px-8 md:pt-4 md:pb-8">
            
            <!-- 1. Tab Navigation -->
            <nav class="flex border-b border-slate-200 mb-4 md:mb-6">
                <button id="tab-warmup" data-tab="warmup" class="tab-button py-2 md:py-3 px-2 md:px-3 text-sm text-slate-500 hover:text-blue-600 transition border-b-2 border-transparent tab-active">ì›Œë°ì—…</button>
                <button id="tab-main" data-tab="main" class="tab-button py-2 md:py-3 px-2 md:px-3 text-sm text-slate-500 hover:text-blue-600 transition border-b-2 border-transparent">ë©”ì¸ ì„¸íŠ¸</button>
                <button id="tab-cool" data-tab="cool" class="tab-button py-2 md:py-3 px-2 md:px-3 text-sm text-slate-500 hover:text-blue-600 transition border-b-2 border-transparent">ì¿¨ ë‹¤ìš´</button>
            </nav>

            <!-- Tab Content Containers - All contents will be dynamically inserted here and managed by show/hide class -->
            <div id="tab-containers" class="mb-6 md:mb-8">
                <!-- Content will be injected here on first access -->
            </div>

            <!-- 2. Stopwatch Feature (Second) -->
            <div class="mb-6 md:mb-8 p-4 bg-slate-100 rounded-xl shadow-inner border border-slate-200">
                <h2 class="text-lg font-bold text-slate-700 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    ìŠ¤í†±ì›Œì¹˜ (Stopwatch)
                </h2>
                <div id="stopwatch-display" class="text-5xl font-mono font-extrabold text-slate-800 text-center mb-4">00:00.00</div>
                <div class="flex justify-center space-x-4 mb-4">
                    <button id="startStopBtn" class="flex-1 px-4 py-3 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95 bg-green-600 hover:bg-green-700">ì‹œì‘ (Start)</button>
                    <button id="lapResetBtn" class="flex-1 px-4 py-3 text-slate-700 font-bold rounded-xl shadow-lg transition transform active:scale-95 bg-slate-300 hover:bg-slate-400">ë© (Lap)</button>
                </div>
                <div id="laps-container" class="mt-4 max-h-40 overflow-y-auto space-y-2">
                    <p class="text-sm text-center text-slate-500" id="no-laps-text">ë© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- 3. Interval Calculator (Third) -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-blue-200 mb-6 md:mb-8">
                <h3 class="text-lg font-bold text-slate-700 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13.5a3.5 3.5 0 11-3.5-3.5H9z"></path></svg>
                    ì¸í„°ë²Œ ì‹œê°„ ê³„ì‚°ê¸°
                </h3>
                <p class="text-xs text-slate-500 mb-3">ë³¸ì¸ì˜ í˜„ì¬ 100Y ììœ í˜• ê¸°ë¡ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: 1ë¶„ 10ì´ˆ â†’ 01:10)</p>
                <div class="flex items-center space-x-2 mb-4">
                    <input type="number" id="paceMinute" placeholder="ë¶„ (MM)" min="0" max="99" class="w-1/3 p-2 border border-slate-300 rounded-lg text-center text-sm" value="01">
                    <span class="text-lg font-bold">:</span>
                    <input type="number" id="paceSecond" placeholder="ì´ˆ (SS)" min="0" max="59" class="w-1/3 p-2 border border-slate-300 rounded-lg text-center text-sm" value="10">
                    <button id="calculateBtn" class="w-1/3 bg-blue-600 text-white p-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">ê³„ì‚°</button>
                </div>
                
                <div id="calculationResult" class="text-sm p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                    <p class="font-semibold text-blue-700 mb-1">ì¶”ì²œ ì¸í„°ë²Œ (10-15ì´ˆ íœ´ì‹ ê¸°ì¤€)</p>
                    <p>100Y ì¸í„°ë²Œ: <span id="rec100Y" class="font-bold text-base"></span></p>
                    <p>200Y ì¸í„°ë²Œ: <span id="rec200Y" class="font-bold text-base"></span></p>
                </div>
            </div>
            
            <!-- 4. Gemini AI Swim Coach Feature (UPDATED FOR ENGLISH TIP + TTS) -->
            <div class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-300 mb-6 md:mb-8">
                <h3 class="text-lg font-bold text-blue-700 mb-3 flex items-center">
                    <span class="text-xl mr-2">âœ¨</span> AI ìˆ˜ì˜ ì½”ì¹˜
                </h3>
                
                <!-- Feature 1: Dynamic Tip/Motivation -->
                <p class="text-sm text-slate-600 mb-2">í›ˆë ¨ ë‹¨ê³„ë³„ ì˜ì–´ íŒ & ìŒì„± ì¶œë ¥</p>
                <div class="flex space-x-2 mb-4">
                    <button id="aiTipBtn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg text-sm font-semibold hover:bg-blue-700 transition active:scale-95">
                        âœ¨ ì˜ì–´ íŒ ìƒì„± (Get Tip)
                    </button>
                    <!-- NEW TTS BUTTON -->
                    <button id="aiSpeakBtn" class="w-1/4 bg-green-500 text-white p-3 rounded-lg text-sm font-semibold hover:bg-green-600 transition active:scale-95 disabled:opacity-50" disabled>
                        ğŸ”Š ë“£ê¸°
                    </button>
                </div>
                
                <div id="aiOutput" class="p-3 bg-white rounded-lg border border-slate-200 text-sm text-slate-700 min-h-[50px] mb-4">
                    <!-- Updated default text to English -->
                    <p id="aiTipText">Press the button to get a motivating tip for your warmup!</p>
                </div>
                <!-- TTS Loading Indicator -->
                <div id="ttsLoading" class="mt-1 text-center text-xs text-green-600 hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-green-500 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ìŒì„± ìƒì„± ì¤‘ (Generating Audio)...
                </div>

                <!-- Feature 2: Q&A (Kept in Korean) -->
                <div class="mt-4 border-t border-slate-200 pt-4">
                    <h4 class="font-semibold text-slate-700 mb-2">ğŸŠ í›ˆë ¨ Q&A (ê¶ê¸ˆí•œ ì  ì§ˆë¬¸í•˜ê¸°)</h4>
                    <div class="flex space-x-2">
                        <input type="text" id="aiQuery" placeholder="ìˆ˜ì˜ í…Œí¬ë‹‰ì´ë‚˜ ì»¨ë””ì…”ë‹ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”..." class="flex-1 p-2 border border-slate-300 rounded-lg text-sm">
                        <button id="aiAskBtn" class="bg-purple-600 text-white p-2 rounded-lg text-sm font-semibold hover:bg-purple-700 transition active:scale-95">ì§ˆë¬¸</button>
                    </div>
                    <!-- Loading Indicator -->
                    <div id="aiLoading" class="mt-3 text-center text-sm text-slate-500 hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-purple-500 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ë‹µë³€ ìƒì„± ì¤‘...
                    </div>
                    <!-- Answer Display -->
                    <div id="aiAnswer" class="mt-3 p-3 bg-white rounded-lg border border-slate-200 text-sm text-slate-700 min-h-[50px] hidden">
                        <p id="aiAnswerText" class="text-slate-700">ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
                        <div id="aiSources" class="mt-3 pt-2 border-t border-slate-100 text-xs text-slate-500"></div>
                    </div>
                </div>
            </div>

            <!-- 5. Key Points Alert -->
            <div class="mt-6 p-3 md:p-4 bg-yellow-50 rounded-lg text-xs md:text-sm text-yellow-800">
                <p class="font-semibold mb-1">ğŸ’¡ ì£¼ìš” í¬ì¸íŠ¸:</p>
                <p>25ì•¼ë“œ í’€ì€ í„´ì´ ì¦ìŠµë‹ˆë‹¤. í„´ ë™ì‘ì„ ê°•ë ¥í•˜ê³  íš¨ìœ¨ì ìœ¼ë¡œ ê°€ì ¸ê°€ì•¼ ì§€êµ¬ë ¥ í›ˆë ¨ì˜ íš¨ê³¼ê°€ ê·¹ëŒ€í™”ë©ë‹ˆë‹¤. ë©”ì¸ ì„¸íŠ¸ì—ì„œ ì •í•´ì§„ ê°„ê²© ë‚´ì— ë„ì°©í•˜ëŠ” ê²ƒì— ì§‘ì¤‘í•˜ì„¸ìš”.</p>
            </div>
            
        </div>
    </main>

    <script>
        const TOTAL_DISTANCE = 2700;
        let completedDistance = 0;
        let currentTabKey = 'warmup'; // Keep track of the currently active tab
        const API_KEY = ""; // Gemini API Key
        const MODEL = 'gemini-2.5-flash-preview-09-2025';
        
        // NEW: Stores the latest generated tip text for TTS
        let latestTipText = ""; 

        // --- Stopwatch Variables ---
        let startTime = 0;
        let elapsedTime = 0;
        let timerInterval;
        let isRunning = false;
        let lapCounter = 0;
        let lastLapTime = 0;
        // ---------------------------

        const WORKOUT_DATA = {
            warmup: [
                { id: 'wu1', content: 'ììœ í˜•', distance: 400, effort: 'ë¶€ë“œëŸ½ê²Œ, í¸ì•ˆí•œ í˜¸í¡ ìœ ì§€', rest: '-' },
                { id: 'wu2', content: 'ë“œë¦´/í‚¥ (4 x 50Y)', distance: 200, effort: '25Y í‚¥ + 25Y ë“œë¦´, ì§§ì€ ë°œì°¨ê¸°ë¡œ ì§„í–‰', rest: '15ì´ˆ' },
                { id: 'wu3', content: 'ë³¸ ì˜ë²• (2 x 50Y)', distance: 100, effort: 'ì ‘ì˜ ë˜ëŠ” ë°°ì˜, 70% ë…¸ë ¥ìœ¼ë¡œ ì˜ë²• ê°ê° ìµíˆê¸°', rest: '10ì´ˆ' }
            ],
            main: [
                { id: 'main1', content: 'ì¤‘ê±°ë¦¬ ì¸í„°ë²Œ', baseDistance: 100, reps: 8, effort: 'ììœ í˜• (Threshold Pace, 80-85% ë…¸ë ¥)', rest: '1:25 ê°„ê²© ìœ ì§€ (íœ´ì‹ 15ì´ˆ)', note: 'í„´ í›„ ëŒí•€í‚¥ì— ì§‘ì¤‘í•˜ì„¸ìš”.' },
                { id: 'main2', content: 'ì‰¬ìš´ íšŒë³µ (100Y)', distance: 100, effort: 'ììœ í˜• (ì•„ì£¼ ì²œì²œíˆ íšŒë³µí•˜ë©° ì˜ë²• í’€ê¸°)', rest: '-' },
                { id: 'main3', content: 'ì¥ê±°ë¦¬ ì¸í„°ë²Œ', baseDistance: 200, reps: 4, effort: 'ììœ í˜• (Threshold Pace, 80% ë…¸ë ¥)', rest: '2:45 ê°„ê²© ìœ ì§€ (íœ´ì‹ 00:25)', note: 'ì¼ì •í•œ í˜ì´ìŠ¤ì™€ ë¦¬ë“¬ ìœ ì§€ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.' }
            ],
            cool: [
                { id: 'cd1', content: 'íšŒë³µ ìˆ˜ì˜ (300Y)', distance: 300, effort: 'ëŠë¦¬ê³  ë¶€ë“œëŸ¬ìš´ ììœ í˜• ë° ë°°ì˜', rest: '-' },
                { id: 'cd2', content: 'ìŠ¤íŠ¸ë ˆì¹­', distance: 0, effort: 'ìˆ˜ì˜ í›„ ì–´ê¹¨, ë“±, ë‹¤ë¦¬ ìŠ¤íŠ¸ë ˆì¹­ 5ë¶„', rest: '-' }
            ]
        };
        
        const WORKOUT_CONTEXT = {
            warmup: {
                title: 'ì›Œë°ì—…', 
                description: 'ëª¸ì„ ë¶€ë“œëŸ½ê²Œ í’€ê³  ì‹¬ë°•ìˆ˜ë¥¼ ì²œì²œíˆ ì˜¬ë¦¬ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. (ì´ 700Y)',
                // Updated prompt to request English tip, max 2 sentences
                prompt: 'Provide a concise, highly motivating tip or advice for muscle activation and injury prevention during the swimming warm-up phase. The response must be in English and no more than two sentences long. Use an energetic and positive tone.'
            },
            main: {
                title: 'ë©”ì¸ ì„¸íŠ¸', 
                description: 'ì§€êµ¬ë ¥ê³¼ í˜ì´ìŠ¤ ìœ ì§€ë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ í›ˆë ¨í•˜ë©°, ì„ê³„ì ì„ ë„˜ë‚˜ë“œëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. (ì´ 1,700Y)',
                // Updated prompt to request English tip, max 2 sentences
                prompt: 'Provide a specific, professional tip for maintaining pace, improving turn efficiency, or managing mental fortitude during the main interval set of a swim workout. The response must be in English and no more than two sentences long. Use a challenging and focused tone.'
            },
            cool: {
                title: 'ì¿¨ ë‹¤ìš´', 
                description: 'ì‹¬ë°•ìˆ˜ë¥¼ ë‚®ì¶”ê³  ê·¼ìœ¡ì˜ ê¸´ì¥ì„ í’€ì–´ íšŒë³µì„ ë•ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. (ì´ 300Y)',
                // Updated prompt to request English tip, max 2 sentences
                prompt: 'Provide a gentle reminder emphasizing the importance of muscle relaxation and recovery after a swim workout, mentioning soft stretching or hydration. The response must be in English and no more than two sentences long. Use a calm and encouraging tone.'
            }
        };

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.round(seconds % 60);
            return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        // --- Base64 and Audio Utility Functions (NEW) ---

        /**
         * Base64 stringì„ ArrayBufferë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (TTSìš©)
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * DataViewì— ë¬¸ìì—´ì„ ì”ë‹ˆë‹¤. (WAV í—¤ë” ìƒì„±ìš©)
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        /**
         * PCM (Signed 16-bit) ë°ì´í„°ë¥¼ WAV íŒŒì¼ í˜•ì‹ì˜ Blobìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (TTSìš©)
         * @param {Int16Array} pcm16 - Signed 16-bit PCM data.
         * @param {number} sampleRate - Sample rate (e.g., 24000).
         * @returns {Blob} WAV file Blob.
         */
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            // RIFF identifier 'RIFF'
            writeString(view, 0, 'RIFF');
            // file length
            view.setUint32(4, 36 + pcm16.length * 2, true);
            // RIFF type 'WAVE'
            writeString(view, 8, 'WAVE');
            // format chunk identifier 'fmt '
            writeString(view, 12, 'fmt ');
            // format chunk length
            view.setUint32(16, 16, true);
            // sample format (1 - PCM)
            view.setUint16(20, 1, true);
            // number of channels
            view.setUint16(22, 1, true);
            // sample rate
            view.setUint32(24, sampleRate, true);
            // byte rate (SampleRate * Channels * BitsPerSample/8)
            view.setUint32(28, sampleRate * 2, true);
            // block align (Channels * BitsPerSample/8)
            view.setUint16(32, 2, true);
            // bits per sample
            view.setUint16(34, 16, true);
            // data chunk identifier 'data'
            writeString(view, 36, 'data');
            // data chunk length
            view.setUint32(40, pcm16.length * 2, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        /**
         * AI íŒì„ ìŒì„±ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤. (NEW)
         */
        async function speakAITip(text) {
            if (!text || document.getElementById('aiSpeakBtn').disabled) return;
            
            const aiSpeakBtn = document.getElementById('aiSpeakBtn');
            const ttsLoading = document.getElementById('ttsLoading');
            
            // UI ìƒíƒœ ë³€ê²½
            aiSpeakBtn.disabled = true;
            aiSpeakBtn.textContent = 'ğŸ”Š ìƒì„± ì¤‘...';
            ttsLoading.classList.remove('hidden');

            const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
            const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`;
            
            // Note: The TTS API call expects the prompt to be the text to be spoken.
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" } // Upbeat English voice
                        }
                    }
                },
            };

            try {
                const result = await exponentialBackoffFetch(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType; // Expected: audio/L16;rate=24000

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    // Blob URL ìƒì„± (media-src 'blob:' ì´ CSPì— ìˆì–´ì•¼ í•¨)
                    const audioUrl = URL.createObjectURL(wavBlob); 
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl); // Clean up the URL after playback
                    };

                } else {
                    console.error("TTS Response Error: No valid audio data received.", part);
                    throw new Error("Invalid audio response format. Check console for details.");
                }

            } catch (error) {
                console.error("TTS API Error:", error);
                document.getElementById('aiTipText').innerHTML += `<br><span class="text-red-500 text-xs"> (TTS Error: ${error.message})</span>`;
            } finally {
                // UI ìƒíƒœ ë³µì›
                aiSpeakBtn.disabled = false;
                aiSpeakBtn.textContent = 'ğŸ”Š ë“£ê¸°';
                ttsLoading.classList.add('hidden');
            }
        }

        // --- API & LLM Functions ---

        /**
         * Exponential backoffì„ ì‚¬ìš©í•˜ì—¬ API ìš”ì²­ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        if (i === maxRetries - 1) throw new Error("API rate limit exceeded after all retries.");
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                         // Attempt to read body for more specific error message
                        let errorText = await response.text();
                        if (errorText.length > 500) errorText = errorText.substring(0, 500) + "..."; // Truncate long error messages
                        throw new Error(`API returned status ${response.status}: ${errorText}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * í˜„ì¬ íƒ­ ì»¨í…ìŠ¤íŠ¸ì— ë§ëŠ” AI íŒì„ ìƒì„±í•©ë‹ˆë‹¤. (MODIFIED)
         */
        async function getAITip() {
            const context = WORKOUT_CONTEXT[currentTabKey];
            const aiTipTextElement = document.getElementById('aiTipText');
            const aiTipBtn = document.getElementById('aiTipBtn');
            const aiSpeakBtn = document.getElementById('aiSpeakBtn');
            
            aiSpeakBtn.disabled = true; // Disable speaker button until text is ready
            latestTipText = ""; // Clear previous text

            aiTipTextElement.innerHTML = `<span class="text-slate-500">AI Coach is thinking...</span>`;
            aiTipBtn.disabled = true;
            aiTipBtn.textContent = 'âœ¨ Generating Tip...';

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
            // System prompt now explicitly guides English output
            const systemPrompt = "You are a world-class swimming coach. You provide clear and concise advice. All responses for this prompt MUST be in ENGLISH and no more than two sentences long."; 
            
            const payload = {
                contents: [{ parts: [{ text: context.prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await exponentialBackoffFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, failed to generate a tip.";
                
                // Store the text for TTS. Remove markdown formatting.
                latestTipText = text.replace(/\*/g, '').trim(); 
                
                // Display the text
                aiTipTextElement.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;

            } catch (error) {
                console.error("AI Tip Generation Error:", error);
                aiTipTextElement.innerHTML = `<span class="text-red-500">âš ï¸ AI Coach Connection Error: ${error.message}. Please check your network or CSP settings.</span>`;
                latestTipText = "";
            } finally {
                aiTipBtn.disabled = false;
                aiTipBtn.textContent = 'âœ¨ ì˜ì–´ íŒ ìƒì„± (Get Tip)';
                if (latestTipText) {
                    aiSpeakBtn.disabled = false;
                }
            }
        }

        /**
         * ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•´ êµ¬ê¸€ ê²€ìƒ‰ ê¸°ë°˜ì˜ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤. (KEPT IN KOREAN)
         */
        async function askAICoach() {
            const queryInput = document.getElementById('aiQuery');
            const query = queryInput.value.trim();
            const aiAskBtn = document.getElementById('aiAskBtn');
            const aiAnswerDiv = document.getElementById('aiAnswer');
            const aiAnswerText = document.getElementById('aiAnswerText');
            const aiSourcesDiv = document.getElementById('aiSources');
            const aiLoading = document.getElementById('aiLoading');

            if (!query) return;

            aiAnswerDiv.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            aiAskBtn.disabled = true;
            aiQuery.disabled = true;
            aiSourcesDiv.innerHTML = '';
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;
            
            // System prompt keeps Q&A in Korean
            const systemPrompt = "ë‹¹ì‹ ì€ ê²½í—˜ì´ í’ë¶€í•˜ê³  ì§€ì‹ì´ í’ë¶€í•œ ìˆ˜ì˜ ì½”ì¹˜ì…ë‹ˆë‹¤. ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•´ ì›¹ ê²€ìƒ‰ì„ í†µí•´ ì–»ì€ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ í•œêµ­ì–´ë¡œ ë‹µë³€í•©ë‹ˆë‹¤. ë‹µë³€ì€ ì•½ 3~5ì¤„ ì •ë„ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ì ˆëŒ€ ì˜ì–´ë¡œ ë‹µë³€í•˜ì§€ ë§ˆì„¸ìš”.";

            const payload = {
                contents: [{ parts: [{ text: `ì‚¬ìš©ìì˜ ì§ˆë¬¸: ${query}` }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const result = await exponentialBackoffFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const candidate = result?.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text || "ì£„ì†¡í•©ë‹ˆë‹¤. ì§ˆë¬¸ì— ë‹µë³€í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                
                let sources = [];
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                aiAnswerText.textContent = text;
                
                if (sources.length > 0) {
                    aiSourcesDiv.innerHTML = '<p class="font-semibold mb-1">ì¶œì²˜:</p>' + sources.map((s, index) => 
                        `<a href="${s.uri}" target="_blank" class="block text-blue-500 hover:text-blue-700 truncate">${index + 1}. ${s.title}</a>`
                    ).join('');
                } else {
                    aiSourcesDiv.innerHTML = 'ì¶œì²˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }

            } catch (error) {
                console.error("AI Coach Q&A Error:", error);
                aiAnswerText.textContent = `âš ï¸ AI ì½”ì¹˜ ì—°ê²° ì˜¤ë¥˜: ${error.message}.`;
                aiSourcesDiv.innerHTML = '';
            } finally {
                aiLoading.classList.add('hidden');
                aiAnswerDiv.classList.remove('hidden');
                aiAskBtn.disabled = false;
                aiQuery.disabled = false;
            }
        }

        // --- Progress and State Functions ---

        function updateProgress() {
            completedDistance = 0;
            // DOM ì „ì²´ì—ì„œ ì²´í¬ëœ ëª¨ë“  ì²´í¬ë°•ìŠ¤ë¥¼ ì¿¼ë¦¬
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            checkboxes.forEach(checkbox => {
                completedDistance += parseInt(checkbox.dataset.distance) || 0;
            });

            const percentage = (completedDistance / TOTAL_DISTANCE) * 100;
            document.getElementById('progress-bar').style.width = `${Math.min(100, percentage)}%`;
            document.getElementById('progress-text').textContent = `${completedDistance} / ${TOTAL_DISTANCE} Y`;

            if (completedDistance === TOTAL_DISTANCE) {
                document.getElementById('progress-text').textContent += ' (í›ˆë ¨ ì™„ë£Œ!)';
            }
        }
        
        function saveState() {
            const state = {};
            // DOM ì „ì²´ì—ì„œ ëª¨ë“  ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì €ì¥
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                state[checkbox.id] = checkbox.checked;
            });
            localStorage.setItem('workoutState', JSON.stringify(state));
        }

        // --- Stopwatch Functions (Unchanged) ---
        function displayStopwatchTime(time) {
            const milliseconds = Math.floor((time % 1000) / 10);
            const seconds = Math.floor((time / 1000) % 60);
            const minutes = Math.floor((time / (1000 * 60)) % 60);

            return (
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0') + '.' +
                String(milliseconds).padStart(2, '0').slice(0, 2)
            );
        }

        function startStopwatch() {
            if (!isRunning) {
                startTime = Date.now() - elapsedTime;
                timerInterval = setInterval(updateTime, 10);
                isRunning = true;
                document.getElementById('startStopBtn').textContent = 'ì¼ì‹œì •ì§€ (Pause)';
                document.getElementById('startStopBtn').classList.remove('bg-green-600', 'hover:bg-green-700');
                document.getElementById('startStopBtn').classList.add('bg-red-600', 'hover:bg-red-700');
                document.getElementById('lapResetBtn').textContent = 'ë© (Lap)';
                document.getElementById('lapResetBtn').classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
                document.getElementById('lapResetBtn').classList.add('bg-slate-300', 'hover:bg-slate-400', 'text-slate-700');
            } else {
                clearInterval(timerInterval);
                isRunning = false;
                document.getElementById('startStopBtn').textContent = 'ì¬ê°œ (Resume)';
                document.getElementById('startStopBtn').classList.remove('bg-red-600', 'hover:bg-red-700');
                document.getElementById('startStopBtn').classList.add('bg-green-600', 'hover:bg-green-700');
                document.getElementById('lapResetBtn').textContent = 'ë¦¬ì…‹ (Reset)';
                document.getElementById('lapResetBtn').classList.remove('bg-slate-300', 'hover:bg-slate-400', 'text-slate-700');
                document.getElementById('lapResetBtn').classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
            }
        }

        function updateTime() {
            elapsedTime = Date.now() - startTime;
            document.getElementById('stopwatch-display').textContent = displayStopwatchTime(elapsedTime);
        }

        function recordLap() {
            if (isRunning) {
                lapCounter++;
                const currentLapTime = elapsedTime - lastLapTime;
                lastLapTime = elapsedTime;

                const lapContainer = document.getElementById('laps-container');
                const lapDiv = document.createElement('div');
                lapDiv.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow-sm text-sm font-medium';
                lapDiv.innerHTML = `
                    <span class="text-blue-600 font-bold">ë© ${lapCounter}</span>
                    <span class="font-mono text-slate-800">${displayStopwatchTime(currentLapTime)}</span>
                    <span class="font-mono text-slate-500 w-1/4 text-right hidden sm:inline">ì´: ${displayStopwatchTime(elapsedTime)}</span>
                `;
                lapContainer.prepend(lapDiv);
                document.getElementById('no-laps-text').classList.add('hidden');
            } else {
                // Reset logic when paused
                resetStopwatch();
            }
        }

        function resetStopwatch() {
            clearInterval(timerInterval);
            isRunning = false;
            elapsedTime = 0;
            startTime = 0;
            lapCounter = 0;
            lastLapTime = 0;

            document.getElementById('stopwatch-display').textContent = '00:00.00';
            document.getElementById('startStopBtn').textContent = 'ì‹œì‘ (Start)';
            document.getElementById('startStopBtn').classList.remove('bg-red-600', 'hover:bg-red-700');
            document.getElementById('startStopBtn').classList.add('bg-green-600', 'hover:bg-green-700');
            
            document.getElementById('lapResetBtn').textContent = 'ë© (Lap)';
            document.getElementById('lapResetBtn').classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
            document.getElementById('lapResetBtn').classList.add('bg-slate-300', 'hover:bg-slate-400', 'text-slate-700');

            document.getElementById('laps-container').innerHTML = '<p class="text-sm text-center text-slate-500" id="no-laps-text">ë© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }


        // --- Interval Calculator Functions ---
        function calculateIntervals() {
            const minInput = document.getElementById('paceMinute').value;
            const secInput = document.getElementById('paceSecond').value;
            
            const minutes = parseInt(minInput) || 0;
            const seconds = parseInt(secInput) || 0;

            const paceSeconds = (minutes * 60) + seconds;

            if (paceSeconds < 30 || paceSeconds > 180) {
                document.getElementById('rec100Y').textContent = 'ìœ íš¨í•œ 100Y ê¸°ë¡ì„ ì…ë ¥í•˜ì„¸ìš”.';
                document.getElementById('rec200Y').textContent = '-';
                document.getElementById('calculationResult').classList.remove('hidden');

                // Invalid input: revert to default/placeholder display text
                WORKOUT_DATA.main[0].rest = '1:25 ê°„ê²© ìœ ì§€ (íœ´ì‹ 15ì´ˆ)';
                WORKOUT_DATA.main[2].rest = '2:45 ê°„ê²© ìœ ì§€ (íœ´ì‹ 00:25)';
                
                // Re-render main set if active to reflect default values
                if (document.getElementById('tab-content-main')) {
                    generateAndAttachTabContent('main', true);
                }
                return;
            }

            // 100Y Interval: Pace + 15 seconds (for ~15s rest)
            const rec100YTime = paceSeconds + 15;
            
            // 200Y Interval: 2 * Pace + 35 seconds (for ~35s rest)
            const rec200YTime = (paceSeconds * 2) + 35; 
            
            const formatted100Y = formatTime(rec100YTime);
            const formatted200Y = formatTime(rec200YTime);

            // Calculate exact rest times in seconds
            const rest100YSeconds = rec100YTime - paceSeconds;
            const rest200YSeconds = rec200YTime - (paceSeconds * 2);

            // 1. Update Interval Calculator UI
            document.getElementById('rec100Y').textContent = formatted100Y;
            document.getElementById('rec200Y').textContent = formatted200Y;
            document.getElementById('calculationResult').classList.remove('hidden');

            // 2. Update WORKOUT_DATA for Main Set (Dynamic Content)
            WORKOUT_DATA.main[0].rest = `${formatted100Y} ê°„ê²© ìœ ì§€ (íœ´ì‹ ${rest100YSeconds}ì´ˆ)`;
            WORKOUT_DATA.main[2].rest = `${formatted200Y} ê°„ê²© ìœ ì§€ (íœ´ì‹ ${formatTime(rest200YSeconds)})`;

            // 3. Conditional Re-render (if Main Set tab is currently active or has been rendered once)
            if (document.getElementById('tab-content-main')) {
                generateAndAttachTabContent('main', true); // Force re-render with new calculated values
            }
        }


        // --- Workout Checklist Functions (Refactored for persistent content) ---
        
        function generateRepetitionItems(item, setKey) {
            let repHtml = '';
            const noteHtml = item.note ? `<p class="text-xs text-yellow-600 mt-1 font-medium">âš ï¸ ${item.note}</p>` : '';

            for (let i = 1; i <= item.reps; i++) {
                const repDistance = item.baseDistance;
                const repId = `${item.id}-rep-${i}`;
                const isLastRep = i === item.reps;
                
                repHtml += `
                    <div class="task-list-item flex items-start p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition border-l-4 ${isLastRep ? 'border-blue-600' : 'border-blue-300'}">
                        <!-- onclick handler removed; using delegated event listener -->
                        <input type="checkbox" id="task-${repId}" data-distance="${repDistance}" class="task-checkbox w-5 h-5 mt-1 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        <label for="task-${repId}" class="ml-4 flex-1 text-slate-700">
                            <span class="font-semibold text-base">${item.baseDistance}Y ì¸í„°ë²Œ (${i}/${item.reps})</span>
                            <span class="task-distance text-sm ml-2 text-blue-600 font-medium">(${repDistance}Y)</span>
                            <p class="text-xs text-slate-500 mt-1">ë…¸ë ¥: ${item.effort}</p>
                            ${item.rest && item.rest !== '-' ? `<p class="text-xs text-slate-500">ê°„ê²©: ${item.rest}</p>` : ''}
                            ${noteHtml}
                        </label>
                    </div>
                `;
            }
            return repHtml;
        }

        function renderSimpleItem(item) {
            return `
                <div class="task-list-item flex items-start p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition">
                    <!-- onclick handler removed; using delegated event listener -->
                    <input type="checkbox" id="task-${item.id}" data-distance="${item.distance}" class="task-checkbox w-5 h-5 mt-1 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    <label for="task-${item.id}" class="ml-4 flex-1 text-slate-700">
                        <span class="font-semibold text-base">${item.content}</span>
                        <span class="task-distance text-sm ml-2 text-blue-600 font-medium ${item.distance === 0 ? 'hidden' : ''}">(${item.distance}Y)</span>
                        <p class="text-xs text-slate-500 mt-1">ë…¸ë ¥: ${item.effort}</p>
                        ${item.rest && item.rest !== '-' ? `<p class="text-xs text-slate-500">ê°„ê²©: ${item.rest}</p>` : ''}
                        ${item.note ? `<p class="text-xs text-yellow-600 mt-1 font-medium">âš ï¸ ${item.note}</p>` : ''}
                    </label>
                </div>
            `;
        }


        /**
         * íƒ­ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê±°ë‚˜ (ìµœì´ˆ ì‹¤í–‰ ì‹œ) ì¬ìƒì„±í•˜ê³  DOMì— ì—°ê²°í•©ë‹ˆë‹¤.
         * @param {string} setKey - 'warmup', 'main', 'cool' ì¤‘ í•˜ë‚˜.
         * @param {boolean} [forceRender=false] - ì´ë¯¸ ë Œë”ë§ëœ ì½˜í…ì¸ ë„ ê°•ì œë¡œ ì¬ìƒì„±í• ì§€ ì—¬ë¶€ (ì˜ˆ: ê³„ì‚°ê¸° ê°’ ë³€ê²½ ì‹œ).
         */
        function generateAndAttachTabContent(setKey, forceRender = false) {
            let container = document.getElementById(`tab-content-${setKey}`);
            const mainContainer = document.getElementById('tab-containers');
            const data = WORKOUT_DATA[setKey];
            const context = WORKOUT_CONTEXT[setKey];
            
            if (!container) {
                // ìµœì´ˆ ë Œë”ë§ì¸ ê²½ìš°
                container = document.createElement('div');
                container.id = `tab-content-${setKey}`;
                container.className = 'tab-content-container'; // Hidden class will be added/removed by switchTabContent
                mainContainer.appendChild(container);
            } else if (!forceRender) {
                // ì´ë¯¸ ë Œë”ë§ë˜ì—ˆê³  ê°•ì œ ë Œë”ë§ ìš”ì²­ì´ ì•„ë‹ˆë©´ ì¤‘ë‹¨
                return;
            } 
            
            // HTML ì½˜í…ì¸  ìƒì„±
            let html = `
                <p class="text-sm text-slate-500 mb-6">${context.description}</p>
                <div class="space-y-4">
            `;
            
            data.forEach(item => {
                if (item.reps) {
                    html += generateRepetitionItems(item, setKey);
                } else {
                    html += renderSimpleItem(item);
                }
            });

            if (setKey === 'main') { 
                 html += `
                    <div class="mt-8 p-4 bg-purple-50 rounded-lg text-sm text-purple-800">
                        <h4 class="font-semibold mb-1">ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ (ë‚œì´ë„ ë†’ì´ê¸°):</h4>
                        <ul class="list-disc list-inside space-y-1 ml-2 text-xs">
                            <li>**ê°„ê²© ì¤„ì´ê¸°:** ê³„ì‚°ëœ 200Y ê°„ê²©ì„ 5-10ì´ˆì”© ì¤„ì—¬ íœ´ì‹ ì‹œê°„ì„ ë‹¨ì¶•í•´ ë³´ì„¸ìš”.</li>
                            <li>**ë°˜ë³µ íšŸìˆ˜ ëŠ˜ë¦¬ê¸°:** 4 x 200Y ì„¸íŠ¸ë¥¼ 5 x 200Yë¡œ ëŠ˜ë ¤ ì´ ê±°ë¦¬ë¥¼ ì¦ê°€í•´ ë³´ì„¸ìš”.</li>
                        </ul>
                    </div>
                `;
            }
            html += '</div>';
            
            // DOM ì—…ë°ì´íŠ¸
            container.innerHTML = html;
            
            // ìƒíƒœ ë³µì› (ì´ ì‹œì ì—ì„œ DOMì— ìš”ì†Œê°€ ì™„ì „íˆ ì‚½ì…ë¨)
            const storedState = JSON.parse(localStorage.getItem('workoutState') || '{}');
            container.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.checked = storedState[checkbox.id] || false;
            });
        }

        function switchTabContent(setKey) {
            currentTabKey = setKey; // Update current tab state
            
            // 1. ì„ íƒëœ íƒ­ì˜ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            generateAndAttachTabContent(setKey); 
            
            // 2. ëª¨ë“  íƒ­ ì»¨í…Œì´ë„ˆë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
            document.querySelectorAll('.tab-content-container').forEach(c => c.classList.add('hidden'));
            
            // 3. ì„ íƒëœ íƒ­ì˜ ì»¨í…Œì´ë„ˆë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
            document.getElementById(`tab-content-${setKey}`).classList.remove('hidden');

            // 4. ì§„í–‰ë¥ ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (ìˆ¨ê²¨ì§„ ì²´í¬ë°•ìŠ¤ê¹Œì§€ ëª¨ë‘ ê³„ì‚°)
            updateProgress();

            // 5. AI Tip Button Text ì—…ë°ì´íŠ¸ (for context)
            const aiTipTextElement = document.getElementById('aiTipText');
            // Update default text to match the new English-only setup for tips
            aiTipTextElement.innerHTML = `Press the button to get a motivating tip for your ${setKey} phase!`;
            
            // 6. Disable Speak button
            document.getElementById('aiSpeakBtn').disabled = true;
            latestTipText = "";
        }

        function handleTabClick(event) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('tab-active', 'text-blue-600', 'border-blue-600');
                btn.classList.add('text-slate-500', 'border-transparent');
            });
            event.target.classList.add('tab-active', 'text-blue-600', 'border-blue-600');
            event.target.classList.remove('text-slate-500', 'border-transparent');
            
            const tabKey = event.target.dataset.tab;
            switchTabContent(tabKey);
        }

        window.onload = function() {
            // Setup Event Listeners
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', handleTabClick);
            });

            document.getElementById('calculateBtn').addEventListener('click', calculateIntervals);
            
            // Stopwatch Event Listeners
            document.getElementById('startStopBtn').addEventListener('click', startStopwatch);
            document.getElementById('lapResetBtn').addEventListener('click', recordLap);

            // AI Coach Event Listeners
            document.getElementById('aiTipBtn').addEventListener('click', getAITip);
            document.getElementById('aiAskBtn').addEventListener('click', askAICoach);
            
            // NEW TTS Event Listener
            document.getElementById('aiSpeakBtn').addEventListener('click', () => speakAITip(latestTipText));

            document.getElementById('aiQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    askAICoach();
                }
            });


            // Input validation for pace fields
            document.getElementById('paceMinute').addEventListener('input', function(e) {
                if (e.target.value.length > 2) e.target.value = e.target.value.slice(0, 2);
            });
            document.getElementById('paceSecond').addEventListener('input', function(e) {
                if (e.target.value.length > 2) e.target.value = e.target.value.slice(0, 2);
                if (e.target.value > 59) e.target.value = 59;
            });

            // State management using event delegation on the main container
            document.getElementById('tab-containers').addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox')) {
                    saveState();
                    updateProgress();
                }
            });

            // Initialize App State: Calculate intervals based on default pace and update WORKOUT_DATA
            calculateIntervals(); 
            
            // Initial render of the Warmup tab
            switchTabContent('warmup');
        };
    </script>
</body>
</html>
